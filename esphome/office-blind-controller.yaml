##############################################################
# Richard Huish 2025
# ESPHome Configuration - Office Blind Controller
# Repository: https://github.com/genestealer/Home-Assistant-Configuration
#
# Description:
# This ESPHome configuration allows automated control of office blinds 
# using a WeMos D1 Mini (ESP8266). It supports:
# - Open, Close, and Stop actions
# - Tilt Open & Tilt Close adjustments
# - Reset function for calibration
# - Manual control via Home Assistant
#
# Includes shared configurations from the 'common' directory
#
# Hardware:
# - ESP8266 (WeMos D1 Mini)
# - Relays or Transistors for Motor Control
#
# Wiring:
# - Blind Control Outputs
#   - Open → GPIO12 (D6)  
#   - Close → GPIO14 (D5)  
#   - Reset → GPIO13 (D7)  
# - Status LED
#   - GPIO2 (D4) → LED Indicator  
#
##############################################################

# Substitutions for Easy Configuration
substitutions:
  # Naming & Identification
  name: office-blind-controller
  friendly_name: "Office Blind Controller"
  ui_comment: "Office Blind Controller" # Shown only in UI

  # Network Configuration (Static IP)
  ip: 192.168.2.52
  gateway: 192.168.2.1
  subnet: 255.255.255.0

  # Status LED Configuration
  status_led: D4  # GPIO2 - Onboard LED
  status_led_inverted: "true"

  # Debug Logging Level
  log_level: DEBUG

  # Sensor Update Interval
  sensor_update_interval: 5min
  wifi_sensor_update_interval: 10min

##############################################################
# Board Configuration
##############################################################
esp8266:
  board: d1_mini

##############################################################
# Import Shared Code (Common Components)
##############################################################
packages:
  device_base: !include common/device_base.yaml
  status_led: !include common/status_led.yaml
  wifi: !include common/device_base_wifi.yaml
  # Uncomment below to remove the status LED:
  # status_led: !remove

##############################################################
# Output Configuration (Motor Control Pins)
##############################################################
output:
  - platform: gpio
    id: open_button_output
    pin:
      number: D6
      inverted: true
      mode: OUTPUT_OPEN_DRAIN  # Sink current for relay/transistor control

  - platform: gpio
    id: close_button_output
    pin:
      number: D5
      inverted: true
      mode: OUTPUT_OPEN_DRAIN  # Sink current for relay/transistor control

  - platform: gpio
    id: set_button_output
    pin:
      number: D7
      inverted: true
      mode: OUTPUT_OPEN_DRAIN  # Sink current for relay/transistor control

##############################################################
# Button Actions for Manual Control
##############################################################
button:

# Open Blinds
  - platform: template
    name: "Open Blinds"
    id: open_button
    on_press:
      - logger.log: "Opening Blinds"
      - output.turn_on: open_button_output
      - delay: 110ms
      - output.turn_off: open_button_output

# Close Blinds
  - platform: template
    name: "Close Blinds"
    id: close_button
    on_press:
      - logger.log: "Closing Blinds"
      - output.turn_on: close_button_output
      - delay: 110ms
      - output.turn_off: close_button_output

# Set Limits
  - platform: template
    name: "Set Blinds Limits (Reset)"
    id: set_button
    device_class: restart
    entity_category: diagnostic
    on_press:
      - logger.log: "Resetting Blinds Limits"
      - output.turn_on: set_button_output
      - delay: 5000ms
      - output.turn_off: set_button_output

# Set Open Position
  - platform: template
    name: "Set Blind Open Position"
    id: set_open_position_button
    entity_category: diagnostic
    on_press:
      - logger.log: "Setting Blinds Open Position"
      - output.turn_on: set_button_output
      - delay: 110ms
      - output.turn_off: set_button_output

# Tilt Open
  - platform: template
    name: "Tilt Open"
    id: tilt_open
    on_press:
      - logger.log: "Tilting Open"
      - output.turn_on: open_button_output
      - delay: 110ms
      - output.turn_off: open_button_output
      - delay: 110ms
      - output.turn_on: open_button_output
      - delay: 110ms
      - output.turn_off: open_button_output

# Tilt Close
  - platform: template
    name: "Tilt Close"
    id: tilt_closed
    on_press:
      - logger.log: "Tilting Closed"
      - output.turn_on: close_button_output
      - delay: 110ms
      - output.turn_off: close_button_output
      - delay: 110ms
      - output.turn_on: close_button_output
      - delay: 110ms
      - output.turn_off: close_button_output

##############################################################
# Global Variables for Blind State Tracking
##############################################################
globals:
  - id: cover_opening
    type: bool
    initial_value: "false"

  - id: cover_closing
    type: bool
    initial_value: "false"

##############################################################
# Cover Control for Automated Blind Movement
##############################################################
cover:
  - platform: template
    name: "Office Blinds"
    id: blinds
    device_class: blind
    optimistic: true
    assumed_state: true

    open_action:
      - logger.log: "Opening Blinds"
      - globals.set:
          id: cover_opening
          value: "true"
      - output.turn_on: open_button_output
      - delay: 110ms
      - output.turn_off: open_button_output
      - delay: 5000ms
      - globals.set:
          id: cover_opening
          value: "false"

    close_action:
      - logger.log: "Closing Blinds"
      - globals.set:
          id: cover_closing
          value: "true"
      - output.turn_on: close_button_output
      - delay: 110ms
      - output.turn_off: close_button_output
      - delay: 5000ms
      - globals.set:
          id: cover_closing
          value: "false"

    stop_action:
      - if:
          condition:
            lambda: 'return id(cover_opening);'
          then:
            - output.turn_on: open_button_output
            - delay: 110ms
            - output.turn_off: open_button_output
            - globals.set:
                id: cover_opening
                value: "false"

      - if:
          condition:
            lambda: 'return id(cover_closing);'
          then:
            - output.turn_on: close_button_output
            - delay: 110ms
            - output.turn_off: close_button_output
            - globals.set:
                id: cover_closing
                value: "false"
