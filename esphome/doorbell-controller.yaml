##############################################################
# Richard Huish 2025
# ESPHome Configuration – Doorbell Controller
# Repository: https://github.com/genestealer/Home-Assistant-Configuration
#
# Description:
# ESP8266-based smart doorbell system controlling a mechanical
# 8 V AC chime via a loft-mounted opto-isolated relay.
# Includes illuminated Neopixel button feedback and integration
# with Home Assistant for notifications and automation.
#
# Features:
# - Physical push-button detection (active low)
# - WS2812 Neopixel illumination for doorbell button
# - Relay driver for mechanical bell with quiet-hours logic
# - Home Assistant integration for alerts and remote ringing
#
# Hardware:
# - NodeMCU v2 (ESP8266)
# - Loft-mounted relay module (opto-isolated, 8 V AC 1 A bell supply)
# - Doorbell button with 2× WS2812 LEDs
# - 5 V DC PoE-style power feed via Cat5
#
# Wiring Summary:
#   D1 (GPIO5)  → Relay control output (Green/White pair to loft relay)
#   D2 (GPIO4)  → Doorbell button input (bare Green/White pair, active low)
#   D4 (GPIO2)  → Neopixel data output (Blue/Grey ribbon pair)
#   5V / GND    → LED power feed (ribbon Green+Purple = 5 V, Orange+Yellow = GND)
#   Separate Cat5 → 8 V AC bell power (Orange/Orange-White)
#   All grounds common between ESP, LEDs, and relay
#
# Quiet Hours:
#   21:00–06:00 reduced relay activation time
#
##############################################################


# Substitutions - Easily Configurable Parameters
substitutions:
  # Naming & Identification
  name: doorbell-controller
  friendly_name: "Doorbell"
  ui_comment: "Doorbell Controller"

  # Network Configuration (Static IP)
  ip: 192.168.2.36
  gateway: 192.168.2.1
  subnet: 255.255.255.0

  # Status LED Configuration
  status_led: D0  # GPIO16 - NodeMCU onboard LED
  status_led_inverted: "true"

  # Debug Logging
  log_level: DEBUG
  

  # Sensor Update Interval
  sensor_update_interval: 30s
  wifi_sensor_update_interval: 10min

##############################################################
# Board Configuration
##############################################################
esp8266:
  board: nodemcuv2

##############################################################
# Import Shared Code (Common Components)
##############################################################
packages:
  device_base: !include common/device_base.yaml
  status_led: !include common/status_led.yaml
  wifi: !include common/device_base_wifi.yaml
  # Uncomment below to remove the status LED from this device:
  # status_led: !remove

##############################################################
# Sub-Devices (group Electricity-related entities)            #
##############################################################
# esphome:
#   devices:

##############################################################
# Quiet Hours Configuration for Doorbell
##############################################################
globals:
  - id: nighttime_start
    type: int
    restore_value: no
    initial_value: '21'  # Quiet hours start at 9 PM
  - id: nighttime_stop
    type: int
    restore_value: no
    initial_value: '6'  # Quiet hours end at 6 AM

##############################################################
# Time Component (For Quiet Hours)
##############################################################
time:
  - platform: homeassistant
    id: homeassistant_time

##############################################################
# Neopixel LED for Doorbell Button
##############################################################

light:
  - platform: neopixelbus
    method: ESP8266_UART1
    id: doorbell_light
    type: GRB
    pin: D4  # GPIO2 - Neopixel Button Light
    num_leds: 2
    name: "Doorbell Button Lights"
    restore_mode: ALWAYS_ON
    variant: 800KBPS
    effects:
      - addressable_rainbow:
          name: Slow Rainbow Effect With Custom Values
          speed: 2
          width: 50
      - addressable_rainbow:
          name: Rainbow Effect With Custom Values
          speed: 10
          width: 50
      - addressable_color_wipe:
      - addressable_color_wipe:
          name: Color Wipe Effect With Custom Values
          colors:
            - red: 100%
              green: 100%
              blue: 100%
              num_leds: 1
            - red: 0%
              green: 0%
              blue: 0%
              num_leds: 1
          add_led_interval: 300ms
          reverse: False

##############################################################
# Doorbell Button Configuration
##############################################################

binary_sensor:
  - platform: gpio
    pin:
      number: D2  # GPIO04 - Doorbell button input
      mode: INPUT_PULLUP
      inverted: true # Active LOW
    name: "Doorbell Button"
    icon: "mdi:doorbell"
    filters:
      - delayed_on: 100ms # Prevent false triggers
      - delayed_off: 100ms # Prevent false resets
    on_press:
      then:
        - logger.log: "Doorbell Button Pressed"
        - light.turn_off:
            id: doorbell_light
        - light.turn_on:
            id: doorbell_light
            brightness: 100%
            # red: 100%
            # green: 100%
            # blue: 100%
            effect: "Color Wipe Effect With Custom Values"
        - switch.turn_on: bellRelay
        # - delay: 250ms
        # - light.turn_on:
        #     id: doorbell_light
        #     brightness: 100%
        #     red: 0%
        #     green: 100%
        #     blue: 0%
        - delay: 2000ms # Inhibit pressing the button for a moment
        - light.turn_on:
            id: doorbell_light
            effect: "Slow Rainbow Effect With Custom Values"


    # on_release:
    #   then:
    #     - light.turn_on:
    #         id: doorbell_light
    #         brightness: 100%
    #         red: 0%
    #         green: 100%
    #         blue: 0%
    # on_press:
    #   then:
    #   - switch.turn_on: bellRelay
    #   - delay: 500ms
    #   - switch.turn_off: bellRelay
    # on_double_click:
    #   min_length: 50ms
    #   max_length: 5000ms
    #   then:
    #   - switch.turn_on: bellRelay
    #   - delay: 5000ms
    # #   - switch.turn_off: bellRelay
    # on_multi_click:
    # # - timing:
    # #     - ON for at most 1s
    # #     - OFF for at most 10s
    # #     - ON for at most 3s
    # #     - OFF for at least 0.2s
    # #   then:
    # #     - logger.log: "Double Clicked"

    # - timing:
    #     - ON for 1s to 2s
    #     - OFF for at least 0.5s
    #   then:
    #     - logger.log: "Single Long Clicked"
    #     - switch.turn_on: bellRelay
    #     - delay: 5000ms
    #     - switch.turn_off: bellRelay
    # - timing:
    #     - ON for at most 1s
    #     - OFF for at least 0.5s
    #   then:
    #     - logger.log: "Single Short Clicked"
    #     - switch.turn_on: bellRelay
    #     - delay: 1000ms
    #     - switch.turn_off: bellRelay
    
##############################################################
# Doorbell Relay (Controls the Buzzer/Chime)
##############################################################

switch:
  # Doorbell relay output, pull low (to GND) to switch relay on.
  # Not exposed to home assistant.
  - platform: gpio
    pin:
      number: D1  # GPIO05 - Relay control
      mode: OUTPUT_OPEN_DRAIN # As we want to sink current from the opto-isolated relay.
      inverted: true
    id: bellRelay
    on_turn_on:
      then:
        - if:
            condition:
              lambda: 'return id(homeassistant_time).now().hour > id(nighttime_start) || id(homeassistant_time).now().hour < id(nighttime_stop);'
            then:
              - logger.log: "Doorbell pushed at nighttime"
              - delay: 400ms
              - switch.turn_off: bellRelay
            else:
              - logger.log: "Doorbell pushed at daytime"
              - delay: 1500ms
              - switch.turn_off: bellRelay
                
    # on_turn_on:
    # - delay: 500ms
    # - switch.turn_off: bellRelay
  

#Manual method to make the bell ring, Timed on time for activating the doorbell ringer  
button:
  - platform: template
    name: "Ring Doorbell"
    icon: "mdi:alarm-bell"
    on_press:
      - switch.turn_on: bellRelay
      
