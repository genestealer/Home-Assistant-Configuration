##############################################################
# ğŸ  UK Daily Air Quality Index (DAQI)
# ğŸ“Œ Computes an Air Quality Index (DAQI) based on PM2.5 & PM10
# ğŸ“‚ https://github.com/koenvervloesem/ESPHome-Air-Quality-Monitor
#
# ğŸ“Œ Used Substitutions:
# - daqi_message_good: Message for good air quality
# - daqi_message_acceptable: Message for acceptable air quality
# - daqi_message_bad: Message for bad air quality
# - daqi_message_verybad: Message for very bad air quality
# - daqi_pm2_5_avg_24h_max_good: Max PM2.5 for "good" air quality
# - daqi_pm2_5_avg_24h_max_acceptable: Max PM2.5 for "acceptable" air quality
# - daqi_pm2_5_avg_24h_max_bad: Max PM2.5 for "bad" air quality
# - daqi_pm10_avg_24h_max_good: Max PM10 for "good" air quality
# - daqi_pm10_avg_24h_max_acceptable: Max PM10 for "acceptable" air quality
# - daqi_pm10_avg_24h_max_bad: Max PM10 for "bad" air quality
#
# IDs used outside this file:
#
# - update_daqi: script to update the daqi
##############################################################
# ğŸ  UK Daily Air Quality Index (DAQI) Bands
# ğŸ“Œ Classification of Air Quality Based on PM2.5 & PM10
##############################################################
# 
# ğŸŒ«ï¸ DAQI Bands for PM2.5 (Âµg/mÂ³) - 24-Hour Mean
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚   Band     â”‚ Index  â”‚ PM2.5 Range (Âµg/mÂ³) â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Low        â”‚ 1      â”‚ 0 - 11             â”‚
# â”‚ Low        â”‚ 2      â”‚ 12 - 23            â”‚
# â”‚ Low        â”‚ 3      â”‚ 24 - 35            â”‚
# â”‚ Moderate   â”‚ 4      â”‚ 36 - 41            â”‚
# â”‚ Moderate   â”‚ 5      â”‚ 42 - 47            â”‚
# â”‚ Moderate   â”‚ 6      â”‚ 48 - 53            â”‚
# â”‚ High       â”‚ 7      â”‚ 54 - 58            â”‚
# â”‚ High       â”‚ 8      â”‚ 59 - 64            â”‚
# â”‚ High       â”‚ 9      â”‚ 65 - 70            â”‚
# â”‚ Very High  â”‚ 10     â”‚ 71 or more         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# 
# ğŸŒ«ï¸ DAQI Bands for PM10 (Âµg/mÂ³) - 24-Hour Mean
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚   Band     â”‚ Index  â”‚ PM10 Range (Âµg/mÂ³) â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Low        â”‚ 1      â”‚ 0 - 16             â”‚
# â”‚ Low        â”‚ 2      â”‚ 17 - 33            â”‚
# â”‚ Low        â”‚ 3      â”‚ 34 - 50            â”‚
# â”‚ Moderate   â”‚ 4      â”‚ 51 - 58            â”‚
# â”‚ Moderate   â”‚ 5      â”‚ 59 - 66            â”‚
# â”‚ Moderate   â”‚ 6      â”‚ 67 - 74            â”‚
# â”‚ High       â”‚ 7      â”‚ 75 - 82            â”‚
# â”‚ High       â”‚ 8      â”‚ 83 - 91            â”‚
# â”‚ High       â”‚ 9      â”‚ 92 - 100           â”‚
# â”‚ Very High  â”‚ 10     â”‚ 101 or more        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

substitutions:
# These are the DAQI threshold values and messages. Adapt to your needs.
  daqi_pm2_5_avg_24h_max_good: "35"
  daqi_pm2_5_avg_24h_max_acceptable: "53" 
  daqi_pm2_5_avg_24h_max_bad: "70"  
  daqi_pm10_avg_24h_max_good: "50"
  daqi_pm10_avg_24h_max_acceptable: "75"  
  daqi_pm10_avg_24h_max_bad: "100" 
  daqi_message_good: "Good"
  daqi_message_acceptable: "Acceptable"
  daqi_message_bad: "Bad"
  daqi_message_verybad: "Very Bad"
  daqi_colour_good: "Green"
  daqi_colour_acceptable: "Yellow"
  daqi_colour_bad: "Orange"
  daqi_colour_verybad: "Red"

sensor:
  - platform: template
    name: "PM 01.0 24h average"
    id: pm1_0_avg_24h
    icon: mdi:chemical-weapon
    unit_of_measurement: Âµg/mÂ³
    lambda: |-
      return id(pm1_0_value_std).state;
    update_interval: ${pmsx003_update_interval}
    filters:
      - sliding_window_moving_average:
          window_size: 1440  # = 24 hours x 60 minutes
          send_every: 1
    on_value:
      then:
        - script.execute: update_daqi
  - platform: template
    name: "PM 02.5 24h average"
    id: pm2_5_avg_24h
    icon: mdi:chemical-weapon
    unit_of_measurement: Âµg/mÂ³
    lambda: |-
      return id(pm2_5_value_std).state;
    update_interval: ${pmsx003_update_interval}
    filters:
      - sliding_window_moving_average:
          window_size: 1440  # = 24 hours x 60 minutes
          send_every: 1
    on_value:
      then:
        - script.execute: update_daqi
  - platform: template
    name: "PM 10 24h average"
    id: pm10_avg_24h
    icon: mdi:air-filter
    unit_of_measurement: Âµg/mÂ³
    lambda: |-
      return id(pm10_value_std).state;
    update_interval: ${pmsx003_update_interval}
    filters:
      - sliding_window_moving_average:
          window_size: 1440  # = 24 hours x 60 minutes
          send_every: 1
    on_value:
      then:
        - script.execute: update_daqi
# ğŸ“Š DAQI Text Representation
  - platform: template
    name: "PM 01.0 rolling 30 minute average"
    id: pm1_0_avg_30m
    icon: mdi:molecule
    unit_of_measurement: Âµg/mÂ³
    lambda: |-
      return id(pm1_0_value_std).state;
    update_interval: ${pmsx003_update_interval}
    filters:
      - sliding_window_moving_average:
          window_size: 900
          send_every: 15
          send_first_at: 15
    on_value:
      then:
        - script.execute: update_daqi
  - platform: template
    name: "PM 02.5 rolling 30 minute average"
    id: pm2_5_avg_30m
    icon: mdi:molecule
    unit_of_measurement: Âµg/mÂ³
    lambda: |-
      return id(pm2_5_value_std).state;
    update_interval: ${pmsx003_update_interval}
    filters:
      - sliding_window_moving_average:
          window_size: 900
          send_every: 15
          send_first_at: 15
    on_value:
      then:
        - script.execute: update_daqi
  - platform: template
    name: "PM 10 rolling 30 minute average"
    id: pm10_avg_30m
    icon: mdi:molecule
    unit_of_measurement: Âµg/mÂ³
    lambda: |-
      return id(pm10_value_std).state;
    update_interval: ${pmsx003_update_interval}
    filters:
      - sliding_window_moving_average:
          window_size: 900
          send_every: 15
          send_first_at: 15
    on_value:
      then:
        - script.execute: update_daqi



# A textual presentation of the daqi: good, acceptable, bad
text_sensor:
  - platform: template
    name: "Air Quality Index"
    id: daqi
    icon: mdi:air-filter
    update_interval: never

  - platform: template
    name: DAQI Color
    icon: mdi:pine-tree-fire
    id: daqi_color
    update_interval: never

# ğŸ“œ DAQI Update Script
# This script is called on every update of the relevant sensor values.
script:
  - id: update_daqi
    mode: restart
    then:
      # Very Bad if at least one of the sensor values is very bad
      - if:
          condition:
            or:
              - sensor.in_range:
                  id: pm2_5_avg_24h
                  above: ${daqi_pm2_5_avg_24h_max_bad}
              - sensor.in_range:
                  id: pm10_avg_24h
                  above: ${daqi_pm10_avg_24h_max_bad}
          then:
            - text_sensor.template.publish:
                id: daqi
                state: ${daqi_message_verybad}
            - text_sensor.template.publish:
                id: daqi_color
                state: ${daqi_colour_verybad}
          else:
            # Bad if at least one of the sensor values is bad
            - if:
                condition:
                  or:
                    - sensor.in_range:
                        id: pm2_5_avg_24h
                        above: ${daqi_pm2_5_avg_24h_max_acceptable}
                    - sensor.in_range:
                        id: pm10_avg_24h
                        above: ${daqi_pm10_avg_24h_max_acceptable}
                then:
                  - text_sensor.template.publish:
                      id: daqi
                      state: ${daqi_message_bad}
                  - text_sensor.template.publish:
                      id: daqi_color
                      state: ${daqi_colour_bad}
                  # - script.execute: show_bad
                else:
                  # Acceptable if at least one of the sensor values is acceptable
                  - if:
                      condition:
                        or:
                          - sensor.in_range:
                              id: pm2_5_avg_24h
                              above: ${daqi_pm2_5_avg_24h_max_good}
                          - sensor.in_range:
                              id: pm10_avg_24h
                              above: ${daqi_pm10_avg_24h_max_good}
                      then:
                        - text_sensor.template.publish:
                            id: daqi
                            state: ${daqi_message_acceptable}
                        - text_sensor.template.publish:
                            id: daqi_color
                            state: ${daqi_colour_acceptable}
                        # - script.execute: show_acceptable
                      else:
                        # Otherwise good (all of the sensor values are good)
                        - text_sensor.template.publish:
                            id: daqi
                            state: ${daqi_message_good}
                        -  text_sensor.template.publish:
                            id: daqi_color
                            state: ${daqi_colour_good}
                        # - script.execute: show_good



# # This script is called on every update of the relevant sensor values.
# script:
#   - id: update_daqi
#     mode: restart
#     then:
#       # Bad if at least one of the sensor values is bad
#       - if:
#           condition:
#             or:
#               - sensor.in_range:
#                   id: pm2_5_avg_24h
#                   above: ${daqi_pm2_5_avg_24h_max_acceptable}
#               - sensor.in_range:
#                   id: pm10_avg_24h
#                   above: ${daqi_pm10_avg_24h_max_acceptable}
#           then:
#             - text_sensor.template.publish:
#                 id: daqi
#                 state: ${daqi_message_bad}
#             # - script.execute: show_bad
#           else:
#             # Acceptable if at least one of the sensor values is acceptable
#             - if:
#                 condition:
#                   or:
#                     - sensor.in_range:
#                         id: pm2_5_avg_24h
#                         above: ${daqi_pm2_5_avg_24h_max_good}
#                     - sensor.in_range:
#                         id: pm10_avg_24h
#                         above: ${daqi_pm10_avg_24h_max_good}
#                 then:
#                   - text_sensor.template.publish:
#                       id: daqi
#                       state: ${daqi_message_acceptable}
#                   # - script.execute: show_acceptable
#                 else:
#                   # Otherwise good (all of the sensor values are good)
#                   - text_sensor.template.publish:
#                       id: daqi
#                       state: ${daqi_message_good}
#                   # - script.execute: show_good



